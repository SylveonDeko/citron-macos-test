name: Build Citron (macOS)

concurrency:
  group: build-macos-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [main]
  workflow_dispatch: {}

jobs:
  build:
    name: "Citron Build (macOS)"
    runs-on: macos-14
    timeout-minutes: 180

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install Build Dependencies
        run: |
          brew install ninja cmake nasm boost fmt lz4 nlohmann-json zlib zstd openssl@3 sdl2 pkg-config ffmpeg openal-soft libusb autoconf automake libtool

      - name: Get Version
        id: version
        run: |
          VERSION=$(git rev-parse --short HEAD)
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

      - name: Configure CMake
        run: |
          cmake -B build -S . -G "Ninja" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
            -DCMAKE_PREFIX_PATH="/opt/homebrew/opt/openal-soft" \
            -DENABLE_QT=ON \
            -DCITRON_ENABLE_LTO=ON \
            -DCITRON_TESTS=OFF \
            -DUSE_DISCORD_PRESENCE=ON \
            -DENABLE_WEB_SERVICE=ON \
            -DENABLE_SDL2=ON

      - name: Build Citron
        run: cmake --build build --config Release

      - name: Package macOS Build
        run: |
          set -e
          mkdir -p dist
          APP_BUNDLE_PATH="build/bin/citron.app"
          if [ ! -d "$APP_BUNDLE_PATH" ]; then
            echo "::error::Could not find citron.app bundle after build!"
            exit 1
          fi

          MACDEPLOYQT_PATH="build/externals/qt/6.7.3/macos/bin/macdeployqt"
          QT_LIB_PATH="build/externals/qt/6.7.3/macos/lib"

          if [ ! -f "$MACDEPLOYQT_PATH" ]; then
            echo "::error::Could not find macdeployqt!"
            exit 1
          fi

          "$MACDEPLOYQT_PATH" "$APP_BUNDLE_PATH" -libpath="$QT_LIB_PATH" -verbose=1 -always-overwrite

          FRAMEWORKS_PATH="$APP_BUNDLE_PATH/Contents/Frameworks"
          EXECUTABLE_PATH="$APP_BUNDLE_PATH/Contents/MacOS/citron"

          install_name_tool -add_rpath "@executable_path/../Frameworks" "$EXECUTABLE_PATH" 2>/dev/null || true

          find "$FRAMEWORKS_PATH" -name "*.dylib" -type f | while read -r dylib; do
            dylib_name=$(basename "$dylib")
            install_name_tool -id "@rpath/$dylib_name" "$dylib" 2>/dev/null || true
            otool -L "$dylib" 2>/dev/null | grep -E "^\s+/" | awk '{print $1}' | while read -r dep; do
              dep_name=$(basename "$dep")
              if [ -f "$FRAMEWORKS_PATH/$dep_name" ]; then
                install_name_tool -change "$dep" "@rpath/$dep_name" "$dylib" 2>/dev/null || true
              fi
            done
          done

          otool -L "$EXECUTABLE_PATH" 2>/dev/null | grep -E "^\s+/" | awk '{print $1}' | while read -r dep; do
            dep_name=$(basename "$dep")
            if [ -f "$FRAMEWORKS_PATH/$dep_name" ]; then
              install_name_tool -change "$dep" "@rpath/$dep_name" "$EXECUTABLE_PATH" 2>/dev/null || true
            fi
          done

          find "$FRAMEWORKS_PATH" -name "*.framework" -type d | while read -r framework_dir; do
            framework_name=$(basename "$framework_dir" .framework)
            framework_binary="$framework_dir/Versions/A/$framework_name"
            [ ! -f "$framework_binary" ] && framework_binary="$framework_dir/$framework_name"
            [ -f "$framework_binary" ] && install_name_tool -id "@rpath/$framework_name.framework/Versions/A/$framework_name" "$framework_binary" 2>/dev/null || true
          done

          chmod -R u+w "$APP_BUNDLE_PATH"
          codesign --force --deep -s - "$APP_BUNDLE_PATH"

          DMG_FILENAME="Citron-macOS-${{ steps.version.outputs.VERSION }}.dmg"
          hdiutil create -fs HFS+ -srcfolder "$APP_BUNDLE_PATH" -volname "Citron" "./$DMG_FILENAME"
          mv "$DMG_FILENAME" ./dist/

      - name: Upload macOS Build
        uses: actions/upload-artifact@v4
        with:
          name: Citron-macOS
          path: "dist/*.dmg"
